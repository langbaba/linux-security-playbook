---
# 适用的服务器操作系统为 Debian 或 Ubuntu
- hosts: aliyun-servers
  # 请设置 deploy_account 部署用户名，建议将用户命名为 deploy
  # 请设置 logwatch_email 邮箱，用于接收系统发出的高风险报告
  vars:
  - deploy_account: deploy
  - logwatch_email: my_email@myhost.com


  # 终端将提示你设置 deploy_account 部署用户的密码
  vars_prompt:
  - name: "deploy_password"
    prompt: "请设置 {{deploy_account}} 用户的密码"
    private: yes
    encrypt: "sha512_crypt"
    confirm: yes
    salt_size: 7

  tasks:
  - name: 更新 APT package cache，相当于运行 apt-get update
    apt: update_cache=yes

  - name: 更新 APT源，相当于运行 apt-get upgrade
    apt: upgrade=yes

  - name: 创建一个部署用户
    user: name="{{deploy_account}}" password="{{deploy_password}}"

  - name: 上传个人 SSH 公钥到部署用户认证的 SSH 公钥列表
    authorized_key: user="{{deploy_account}}" key="{{ lookup('file', '~/.ssh/my_key.pub') }}"

  - name: 为部署用户添加 sudo 权限
    lineinfile: dest=/etc/sudoers regexp="deploy ALL" line="deploy ALL=(ALL) ALL" state=present

  - name: 禁用 root 用户的 SSH 登录
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
    notify: Restart sshd

  - name: 禁用 SSH 密码验证登录，未来只能用个人 SSH 公钥自动验证登录
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
    notify: Restart sshd

  - name: 安装 fail2ban
    apt: pkg=fail2ban state=installed

  - name: 安装可用的 bug 修复包和系统安全修复包
    apt: pkg=unattended-upgrades state=present

  - name: 修改系统自动安装配置，每天自动安装可用的 bug 修复包和系统安全修复包
    lineinfile: dest=/etc/apt/apt.conf.d/10periodic line='APT::Periodic::Unattended-Upgrade "1";'

  - name: 安装 logwatch 程序
    apt: pkg=logwatch state=installed

  - name: 让 logwatch 程序每天检查 log 文件，如果发现高级别风险，则发送邮件到你的邮箱
    lineinfile: dest=/etc/cron.daily/00logwatch regexp="^/usr/sbin/logwatch" line="/usr/sbin/logwatch --output mail --mailto $logwatch_email --detail high" state=present create=yes

  # 重启 ssh 服务
  handlers:
  - name: Restart sshd
    service: name=ssh state=restarted